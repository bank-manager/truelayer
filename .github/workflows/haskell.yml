name: Haskell CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  build:
    runs-on: self-hosted
    steps:
      - name: 'GitHub actions env workaround'
        run: 'echo "ACTIONS_ALLOW_UNSECURE_COMMANDS=true" >> $GITHUB_ENV'

      - uses: actions/checkout@v2

      - name: Verify pre-commit
        uses: pre-commit/action@v2.0.3

      - name: Install Dependencies
        run: |
          stack --no-terminal --install-ghc install --bench --only-dependencies

      - name: Build
        id: build
        run: |
          stack --no-terminal build --bench --test --no-run-tests --haddock --no-run-benchmarks --no-haddock-deps

      - name: Test
        id: test
        run: |
          stack --no-terminal test
      - name: Build Docs
        run: |
          FILEPATH=$(cabal haddock | tail -1)
          echo $FILEPATH
          FOLDERPATH=$(dirname $FILEPATH)
          echo $FOLDERPATH
          cp -a $FOLDERPATH ./html
          echo "truelayer.bank.rly.rocks" > ./html/CNAME
      - name: Publish Docs
        if: github.event_name == 'push'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./html
          enable_jekyll: true
